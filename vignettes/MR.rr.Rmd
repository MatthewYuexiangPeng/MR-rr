---
title: "Small demo of the MR.rr package"
author: "Yuexiang Peng, Zhilong Zhang"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float:
      toc_collapsed: true
    theme: united
vignette: >
  %\VignetteIndexEntry{Small demo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This is a vignette for our MR-rr package. This package contains three estimators, including the naive MR-rr estimator, the MR-rr estimator, and the the MR-rr estimator with regularization. The package also contains functions to perform simulation to test the estimators. 

We will use the GWAS-Lipid data incorporated in the package to generate the true parameters and a rank 5 causal effect matrix C from 24 dimension exposures to 10 dimension outcomes. Then we will simulate the data with the true parameters and run the naive MR-rr estimator and MR-rr estimator with regularization to compare the performance with respect to true C.


```{r}
library(MR.rr)
set.seed(123)

sim_result = run_simulation(regularized = TRUE, regularization_rate = 1e-13)
bias_naive_MRrr = sim_result[[1]]
bias_MRrr_regularized = sim_result[[2]]
print("This is a demo of the output format of the run_simulation function:")
str(bias_naive_MRrr)
print("This is a summary of the entrywise bias of the naive MR-rr estimator:")
summary(unlist(bias_naive_MRrr))
print("This is a summary of the entrywise bias of the MR-rr estimator with regularization:")
summary(unlist(bias_MRrr_regularized))
```

From a rough glance, we can see that the MR-rr estimator with regularization has a smaller bias than the naive MR-rr estimator. We can also visualize the results by plotting the boxplots of the bias and the heatmaps of the bias and standard deviation by the following functions.

The boxplots function takes the bias matrices of the naive MR-rr estimator and the MR-rr estimator with regularization as input and plots the boxplot of the entry-wise bias of the causal effect matrix C. 

```{r}
plot_boxplot(bias_naive_MRrr, bias_MRrr_regularized, weight_to_plot = "0.2",
             individual_plot = TRUE, rank_by = "bias")
```

From the boxplot, we can see that the MR-rr estimator with regularization has a smaller bias than the naive MR-rr estimator. Then, we use the heatmap to visualize the bias and standard deviation of each entry of the estimator comapring to the causal effect C.

```{r}
plot_heatmap(bias_naive_MRrr, bias_MRrr_regularized, weight_to_plot = "0.2")
```

We see that when the IV strength is about 1.5, the MR-rr estimator with regularization has a smaller bias and similar standard deviation comparing to the naive MR-rr estimator.

Finally, we test whether the bootstrap 95 percent confidence interval covers the true causal effect matrix C with about 95% probability.

```{r}
nonpara_bootstrap(me_weight = 0.2, regularized = TRUE, regularization_rate = 1e-13)
```















